<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Compute the density of simulated doublets — computeDoubletDensity • scDblFinder</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Compute the density of simulated doublets — computeDoubletDensity"><meta name="description" content="Identify potential doublet cells based on the local density of simulated doublet expression profiles.
This replaces the older doubletCells function from the scran package."><meta property="og:description" content="Identify potential doublet cells based on the local density of simulated doublet expression profiles.
This replaces the older doubletCells function from the scran package."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">scDblFinder</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.19.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/scDblFinder.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/computeDoubletDensity.html">Scoring potential doublets from simulated densities</a></li>
    <li><a class="dropdown-item" href="../articles/findDoubletClusters.html">Detecting clusters of doublet cells with DE analyses</a></li>
    <li><a class="dropdown-item" href="../articles/introduction.html">Introduction to the scDblFinder package</a></li>
    <li><a class="dropdown-item" href="../articles/recoverDoublets.html">Recovering intra-sample doublets</a></li>
    <li><a class="dropdown-item" href="../articles/scATAC.html">Doublet identifiation in single-cell ATAC-seq</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/plger/scDblFinder/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Compute the density of simulated doublets</h1>
      <small class="dont-index">Source: <a href="https://github.com/plger/scDblFinder/blob/devel/R/computeDoubletDensity.R" class="external-link"><code>R/computeDoubletDensity.R</code></a></small>
      <div class="d-none name"><code>computeDoubletDensity.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Identify potential doublet cells based on the local density of simulated doublet expression profiles.
This replaces the older <code>doubletCells</code> function from the <span class="pkg">scran</span> package.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">computeDoubletDensity</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for class 'ANY'</span></span>
<span><span class="fu">computeDoubletDensity</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  size.factors.norm <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  size.factors.content <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  subset.row <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  niters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">10000</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  block <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  dims <span class="op">=</span> <span class="fl">25</span>,</span>
<span>  BNPARAM <span class="op">=</span> <span class="fu">KmknnParam</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  BSPARAM <span class="op">=</span> <span class="fu">bsparam</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SerialParam-class.html" class="external-link">SerialParam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for class 'SummarizedExperiment'</span></span>
<span><span class="fu">computeDoubletDensity</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span>, assay.type <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S4 method for class 'SingleCellExperiment'</span></span>
<span><span class="fu">computeDoubletDensity</span><span class="op">(</span><span class="va">x</span>, size.factors.norm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">sizeFactors</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A numeric matrix-like object of count values,
where each column corresponds to a cell and each row corresponds to an endogenous gene.</p>
<p>Alternatively, a SummarizedExperiment or <a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a> object containing such a matrix.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>For the generic, additional arguments to pass to specific methods.</p>
<p>For the SummarizedExperiment and SingleCellExperiment methods, additional arguments to pass to the ANY method.</p></dd>


<dt id="arg-size-factors-norm">size.factors.norm<a class="anchor" aria-label="anchor" href="#arg-size-factors-norm"></a></dt>
<dd><p>A numeric vector of size factors for normalization of <code>x</code> prior to PCA and distance calculations.
If <code>NULL</code>, defaults to size factors derived from the library sizes of <code>x</code>.</p>
<p>For the SingleCellExperiment method, the default values are taken from <code><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">sizeFactors</a>(x)</code>, if they are available.</p></dd>


<dt id="arg-size-factors-content">size.factors.content<a class="anchor" aria-label="anchor" href="#arg-size-factors-content"></a></dt>
<dd><p>A numeric vector of size factors for RNA content normalization of <code>x</code> prior to simulating doublets.
This is orthogonal to the values in <code>size.factors.norm</code>, see Details.</p></dd>


<dt id="arg-k">k<a class="anchor" aria-label="anchor" href="#arg-k"></a></dt>
<dd><p>An integer scalar specifying the number of nearest neighbours to use to determine the bandwidth for density calculations.</p></dd>


<dt id="arg-subset-row">subset.row<a class="anchor" aria-label="anchor" href="#arg-subset-row"></a></dt>
<dd><p>See <code>?"scran-gene-selection"</code>.</p></dd>


<dt id="arg-niters">niters<a class="anchor" aria-label="anchor" href="#arg-niters"></a></dt>
<dd><p>An integer scalar specifying how many simulated doublets should be generated.</p></dd>


<dt id="arg-block">block<a class="anchor" aria-label="anchor" href="#arg-block"></a></dt>
<dd><p>An integer scalar controlling the rate of doublet generation, to keep memory usage low.</p></dd>


<dt id="arg-dims">dims<a class="anchor" aria-label="anchor" href="#arg-dims"></a></dt>
<dd><p>An integer scalar specifying the number of components to retain after the PCA.</p></dd>


<dt id="arg-bnparam">BNPARAM<a class="anchor" aria-label="anchor" href="#arg-bnparam"></a></dt>
<dd><p>A BiocNeighborParam object specifying the nearest neighbor algorithm.
This should be an algorithm supported by <code>findNeighbors</code>.</p></dd>


<dt id="arg-bsparam">BSPARAM<a class="anchor" aria-label="anchor" href="#arg-bsparam"></a></dt>
<dd><p>A BiocSingularParam object specifying the algorithm to use for PCA, if <code>d</code> is not <code>NA</code>.</p></dd>


<dt id="arg-bpparam">BPPARAM<a class="anchor" aria-label="anchor" href="#arg-bpparam"></a></dt>
<dd><p>A <a href="https://rdrr.io/pkg/BiocParallel/man/BiocParallelParam-class.html" class="external-link">BiocParallelParam</a> object specifying whether the neighbour searches should be parallelized.</p></dd>


<dt id="arg-assay-type">assay.type<a class="anchor" aria-label="anchor" href="#arg-assay-type"></a></dt>
<dd><p>A string specifying which assay values contain the count matrix.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A numeric vector of doublet scores for each cell in <code>x</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function simulates doublets by adding the count vectors for two randomly chosen cells in <code>x</code>.
For each original cell, we compute the density of neighboring simulated doublets and compare it to the density of neighboring original cells.
Genuine doublets should have a high density of simulated doublets relative to the density of its neighbourhood.
Thus, the doublet score for each cell is defined as the ratio of densities of simulated doublets to the density of the original cells.</p>
<p>Densities are calculated in low-dimensional space after a PCA on the log-normalized expression matrix of <code>x</code>.
Simulated doublets are projected into the low-dimensional space using the rotation vectors computed from the original cells.
For each cell, the density of simulated doublets is computed for a hypersphere with radius set to the median distance to the <code>k</code> nearest neighbour.
This is normalized by <code>niters</code>, <code>k</code> and the total number of cells in <code>x</code> to yield the final score.</p>
<p>The two size factor arguments have different roles:</p><ul><li><p><code>size.factors.norm</code> contains the size factors to be used for normalization prior to PCA and distance calculations.
This defaults to the values returned by <code>librarySizeFactors</code> but can be explicitly set to ensure that the low-dimensional space is consistent with that in the rest of the analysis.</p></li>
<li><p><code>size.factors.content</code> is much more important, and represents the size factors that preserve RNA content differences.
This is usually computed from spike-in RNA and ensures that the simulated doublets have the correct ratio of contributions from the original cells.</p></li>
</ul><p>It is possible to set both of these arguments as they are orthogonal to each other.
Setting <code>size.factors.content</code> will not affect the calculation of log-normalized expression values from <code>x</code>.
Conversely, setting <code>size.factors.norm</code> will not affect the ratio in which cells are added together when simulating doublets.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Lun ATL (2018).
Detecting doublet cells with <em>scran</em>.
<a href="https://ltla.github.io/SingleCellThoughts/software/doublet_detection/bycell.html" class="external-link">https://ltla.github.io/SingleCellThoughts/software/doublet_detection/bycell.html</a></p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="findDoubletClusters.html">findDoubletClusters</a></code>, to detect doublet clusters.</p>
<p><code><a href="scDblFinder.html">scDblFinder</a></code>, which uses a hybrid approach involving simulation and overclustering.</p>
<p>More detail on the mathematical background of this function is provided in the corresponding vignette at
<code><a href="../articles/computeDoubletDensity.html">vignette("computeDoubletDensity", package="scDblFinder")</a></code>.</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Aaron Lun</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Mocking up an example.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ngenes</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span></span>
<span class="r-in"><span><span class="va">mu1</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mu2</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mu3</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mu4</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">counts.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">*</span><span class="fl">100</span>, <span class="va">mu1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">ngenes</span><span class="op">)</span> <span class="co"># Pure type 1</span></span></span>
<span class="r-in"><span><span class="va">counts.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">*</span><span class="fl">100</span>, <span class="va">mu2</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">ngenes</span><span class="op">)</span> <span class="co"># Pure type 2</span></span></span>
<span class="r-in"><span><span class="va">counts.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">*</span><span class="fl">100</span>, <span class="va">mu3</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">ngenes</span><span class="op">)</span> <span class="co"># Pure type 3</span></span></span>
<span class="r-in"><span><span class="va">counts.4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">*</span><span class="fl">100</span>, <span class="va">mu4</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">ngenes</span><span class="op">)</span> <span class="co"># Pure type 4</span></span></span>
<span class="r-in"><span><span class="va">counts.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="va">ngenes</span><span class="op">*</span><span class="fl">20</span>, <span class="va">mu1</span><span class="op">+</span><span class="va">mu2</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">ngenes</span><span class="op">)</span> <span class="co"># Doublets (1 &amp; 2)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">counts.1</span>, <span class="va">counts.2</span>, <span class="va">counts.3</span>, <span class="va">counts.4</span>, <span class="va">counts.m</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">counts.m</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Find potential doublets.</span></span></span>
<span class="r-in"><span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu">computeDoubletDensity</span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span>, <span class="va">clusters</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="computeDoubletDensity-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Pierre-Luc Germain.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

